<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix RLS Policies</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .button.success {
            background: #28a745;
        }
        .button.error {
            background: #dc3545;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <h1>üîß Fix RLS Policies for Notifications</h1>
    <p>This tool fixes the Row Level Security policies for the order_notifications table.</p>

    <div class="section">
        <h2>üîç Current Status</h2>
        <button class="button" onclick="checkCurrentPolicies()">Check Current Policies</button>
        <div id="policy-status">Click to check current policies...</div>
    </div>

    <div class="section">
        <h2>üîß Fix Policies</h2>
        <button class="button" onclick="fixRLSPolicies()">Fix RLS Policies</button>
        <button class="button" onclick="enableRealtime()">Enable Real-time</button>
        <div id="fix-status">Click to fix policies...</div>
    </div>

    <div class="section">
        <h2>üß™ Test Notification Creation</h2>
        <button class="button" onclick="testNotificationCreation()">Test Create Notification</button>
        <div id="test-status">Click to test notification creation...</div>
    </div>

    <div class="section">
        <h2>üìù Log</h2>
        <button class="button" onclick="clearLog()">Clear Log</button>
        <div id="log" class="log">Log will appear here...</div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js@2';

        const SUPABASE_URL = "https://htdgoceqepvrffblfvns.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0ZGdvY2VxZXB2cmZmYmxmdm5zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwNTUwNzksImV4cCI6MjA2ODYzMTA3OX0.TJqTe3f0-GjFLoFrT64LKbUJWtXU9ht08tX9O8Yp7y8";

        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('log');
            logElement.innerHTML += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        function setStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        window.checkCurrentPolicies = async function() {
            log('üîç Checking current RLS policies...');
            
            try {
                // Try to query the table to see if we have access
                const { data, error } = await supabase
                    .from('order_notifications')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    log(`‚ùå Query error: ${error.message}`);
                    setStatus('policy-status', 'Policies need fixing - query failed', 'error');
                } else {
                    log('‚úÖ Query successful - policies allow read access');
                    setStatus('policy-status', 'Read access working', 'success');
                }
                
                // Try to insert a test record
                const { error: insertError } = await supabase
                    .from('order_notifications')
                    .insert({
                        order_id: null,
                        notification_type: 'test',
                        title: 'Policy Test',
                        message: 'Testing RLS policies',
                        is_read: true,
                        is_acknowledged: true
                    });
                
                if (insertError) {
                    log(`‚ùå Insert test failed: ${insertError.message}`);
                    setStatus('policy-status', 'Policies need fixing - insert blocked', 'error');
                } else {
                    log('‚úÖ Insert test successful - policies allow write access');
                    setStatus('policy-status', 'All policies working correctly', 'success');
                }
                
            } catch (error) {
                log(`‚ùå Policy check error: ${error.message}`);
                setStatus('policy-status', 'Policy check failed', 'error');
            }
        };

        window.fixRLSPolicies = async function() {
            log('üîß Attempting to fix RLS policies...');
            
            try {
                // Note: We can't directly modify RLS policies from the client
                // This would need to be done in the Supabase dashboard
                log('‚ö†Ô∏è RLS policies must be fixed in Supabase dashboard');
                log('üìã Go to: https://supabase.com/dashboard/project/htdgoceqepvrffblfvns/auth/policies');
                log('üìã Add these policies for order_notifications table:');
                log('   1. SELECT: Allow public access (true)');
                log('   2. INSERT: Allow public access (true)');
                log('   3. UPDATE: Allow public access (true)');
                log('   4. DELETE: Allow public access (true)');
                
                setStatus('fix-status', 'Manual fix required - see log for instructions', 'error');
                
            } catch (error) {
                log(`‚ùå Fix attempt error: ${error.message}`);
                setStatus('fix-status', 'Fix attempt failed', 'error');
            }
        };

        window.enableRealtime = async function() {
            log('üì° Checking real-time status...');
            
            try {
                // Test real-time subscription
                const subscription = supabase
                    .channel('test_realtime')
                    .on('postgres_changes',
                        { event: 'INSERT', schema: 'public', table: 'order_notifications' },
                        (payload) => {
                            log('üì° Real-time event received!');
                            log(`üì° Event: ${JSON.stringify(payload)}`);
                        }
                    )
                    .subscribe((status) => {
                        log(`üì° Subscription status: ${status}`);
                        if (status === 'SUBSCRIBED') {
                            setStatus('fix-status', 'Real-time subscription active', 'success');
                        } else if (status === 'CHANNEL_ERROR') {
                            setStatus('fix-status', 'Real-time subscription failed', 'error');
                        }
                    });
                
                // Clean up after 5 seconds
                setTimeout(() => {
                    subscription.unsubscribe();
                    log('üì° Test subscription cleaned up');
                }, 5000);
                
            } catch (error) {
                log(`‚ùå Real-time test error: ${error.message}`);
                setStatus('fix-status', 'Real-time test failed', 'error');
            }
        };

        window.testNotificationCreation = async function() {
            log('üß™ Testing notification creation...');
            
            try {
                const testNotification = {
                    order_id: null,
                    notification_type: 'test',
                    title: 'Test Notification',
                    message: `Test notification created at ${new Date().toLocaleTimeString()}`,
                    is_read: false,
                    is_acknowledged: false
                };
                
                const { data, error } = await supabase
                    .from('order_notifications')
                    .insert([testNotification])
                    .select()
                    .single();
                
                if (error) {
                    log(`‚ùå Notification creation failed: ${error.message}`);
                    log(`‚ùå Error details: ${JSON.stringify(error)}`);
                    setStatus('test-status', 'Notification creation failed', 'error');
                } else {
                    log('‚úÖ Notification created successfully!');
                    log(`‚úÖ Created notification ID: ${data.id}`);
                    setStatus('test-status', 'Notification creation working', 'success');
                }
                
            } catch (error) {
                log(`‚ùå Test error: ${error.message}`);
                setStatus('test-status', 'Test failed', 'error');
            }
        };

        window.clearLog = function() {
            document.getElementById('log').innerHTML = 'Log cleared...\n';
        };

        // Auto-check policies on load
        window.addEventListener('load', () => {
            setTimeout(checkCurrentPolicies, 1000);
        });
    </script>
</body>
</html>
